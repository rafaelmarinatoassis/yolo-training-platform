{% extends "base.html" %}

{% block title %}Treinar Modelo de IA - YOLO Trainer{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="text-primary mb-2">
                                <i class="bi bi-play-circle"></i>
                                Treinar Modelo de IA
                            </h1>
                            <p class="text-muted mb-0">
                                <i class="bi bi-info-circle"></i>
                                Configure e inicie o treinamento de um modelo personalizado para detectar seus objetos
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="badge bg-success fs-6 p-2">
                                <i class="bi bi-check-circle"></i>
                                Sistema Pronto
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary bg-opacity-10 border-primary">
                <div class="card-body">
                    <h5 class="card-title text-primary">
                        <i class="bi bi-lightbulb"></i>
                        Como funciona o treinamento?
                    </h5>
                    <p class="card-text mb-3">
                        O treinamento √© o processo onde a intelig√™ncia artificial aprende a reconhecer objetos usando seu dataset. 
                        Como ensinar uma crian√ßa: voc√™ mostra exemplos e a IA aprende os padr√µes.
                    </p>
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="p-3">
                                <i class="bi bi-1-circle-fill fs-2 text-primary"></i>
                                <h6 class="mt-2">Selecionar Dataset</h6>
                                <small class="text-muted">Escolha as imagens que a IA vai aprender</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="p-3">
                                <i class="bi bi-2-circle-fill fs-2 text-primary"></i>
                                <h6 class="mt-2">Configurar Modelo</h6>
                                <small class="text-muted">Defina o tipo e precis√£o do modelo</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="p-3">
                                <i class="bi bi-3-circle-fill fs-2 text-primary"></i>
                                <h6 class="mt-2">Aguardar Treino</h6>
                                <small class="text-muted">A IA processa e aprende sozinha</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="p-3">
                                <i class="bi bi-4-circle-fill fs-2 text-primary"></i>
                                <h6 class="mt-2">Modelo Pronto</h6>
                                <small class="text-muted">Use para detectar objetos em novas imagens</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Training Form -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-gear"></i>
                        Configura√ß√£o do Treinamento
                    </h5>
                </div>
                <div class="card-body">
                    <form id="trainingForm">
                        <!-- Step 1: Dataset Selection -->
                        <div class="border-start border-primary border-4 ps-3 mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-1-circle-fill"></i>
                                Escolha seu Dataset
                            </h6>
                            <div class="row">
                                <div class="col-md-8">
                                    <label for="datasetSelect" class="form-label fw-bold">
                                        <i class="bi bi-collection"></i>
                                        Dataset de Treinamento *
                                    </label>
                                    <select class="form-select form-select-lg" id="datasetSelect" name="dataset_id" required>
                                        <option value="">üîç Selecione um dataset...</option>
                                    </select>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle text-primary"></i>
                                        O dataset cont√©m as imagens e anota√ß√µes que a IA usar√° para aprender
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">N√£o tem dataset?</label>
                                    <div class="d-grid">
                                        <a href="{{ url_for('ui.create_dataset_page') }}" class="btn btn-outline-success">
                                            <i class="bi bi-plus-circle"></i>
                                            Criar Novo Dataset
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Model Configuration -->
                        <div class="border-start border-success border-4 ps-3 mb-4">
                            <h6 class="text-success mb-3">
                                <i class="bi bi-2-circle-fill"></i>
                                Configura√ß√µes do Modelo
                            </h6>
                            <div class="row">
                                <div class="col-lg-4">
                                    <div class="mb-3">
                                        <label for="modelVersion" class="form-label fw-bold">
                                            <i class="bi bi-cpu"></i>
                                            Tamanho do Modelo
                                        </label>
                                        <select class="form-select" id="modelVersion" name="model_version">
                                            <option value="n">üèÉ YOLOv8n - Mais R√°pido</option>
                                            <option value="s">‚ö° YOLOv8s - Equilibrado</option>
                                            <option value="m" selected>üéØ YOLOv8m - Recomendado</option>
                                            <option value="l">üîç YOLOv8l - Alta Precis√£o</option>
                                            <option value="x">üèÜ YOLOv8x - M√°xima Precis√£o</option>
                                        </select>
                                        <small class="text-muted">Modelos maiores s√£o mais precisos, mas mais lentos</small>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="mb-3">
                                        <label for="taskType" class="form-label fw-bold">
                                            <i class="bi bi-bullseye"></i>
                                            Tipo de Tarefa
                                        </label>
                                        <select class="form-select" id="taskType" name="task">
                                            <option value="detect" selected>üéØ Detec√ß√£o - Encontrar objetos</option>
                                            <option value="segment">‚úÇÔ∏è Segmenta√ß√£o - Contorno preciso</option>
                                            <option value="classify">üìã Classifica√ß√£o - Apenas categoria</option>
                                        </select>
                                        <small class="text-muted">O que voc√™ quer que a IA fa√ßa</small>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="mb-3">
                                        <label for="device" class="form-label fw-bold">
                                            <i class="bi bi-lightning-charge"></i>
                                            Dispositivo
                                        </label>
                                        <select class="form-select" id="device" name="device">
                                            <option value="auto" selected>ü§ñ Autom√°tico</option>
                                            <option value="cuda">üöÄ GPU (NVIDIA)</option>
                                            <option value="mps">üçé GPU (Apple Silicon)</option>
                                            <option value="cpu">üíª CPU</option>
                                        </select>
                                        <small class="text-muted">Onde processar o treinamento</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Training Parameters -->
                        <div class="border-start border-warning border-4 ps-3 mb-4">
                            <h6 class="text-warning mb-3">
                                <i class="bi bi-3-circle-fill"></i>
                                Par√¢metros de Treinamento
                            </h6>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="epochs" class="form-label fw-bold">
                                            <i class="bi bi-repeat"></i>
                                            √âpocas (Ciclos de Aprendizado)
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">üîÑ</span>
                                            <input type="number" class="form-control" id="epochs" name="epochs" value="100" min="10" max="1000">
                                            <span class="input-group-text">ciclos</span>
                                        </div>
                                        <small class="text-muted">Recomendado: 100-300 para a maioria dos casos</small>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="batchSize" class="form-label fw-bold">
                                            <i class="bi bi-stack"></i>
                                            Batch Size (Imagens por Vez)
                                        </label>
                                        <select class="form-select" id="batchSize" name="batch_size">
                                            <option value="8">üì± 8 - Pouca mem√≥ria</option>
                                            <option value="16" selected>üíª 16 - Padr√£o recomendado</option>
                                            <option value="32">üñ•Ô∏è 32 - Mem√≥ria m√©dia</option>
                                            <option value="64">üöÄ 64 - Muita mem√≥ria</option>
                                        </select>
                                        <small class="text-muted">Quantas imagens processar por vez</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="imgSize" class="form-label fw-bold">
                                            <i class="bi bi-aspect-ratio"></i>
                                            Tamanho da Imagem
                                        </label>
                                        <select class="form-select" id="imgSize" name="img_size">
                                            <option value="416">416x416 - R√°pido</option>
                                            <option value="512">512x512 - Equilibrado</option>
                                            <option value="640" selected>640x640 - Recomendado</option>
                                            <option value="800">800x800 - Alta qualidade</option>
                                        </select>
                                        <small class="text-muted">Resolu√ß√£o das imagens durante treino</small>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="learningRate" class="form-label fw-bold">
                                            <i class="bi bi-speedometer2"></i>
                                            Taxa de Aprendizado
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">üìä</span>
                                            <input type="number" class="form-control" id="learningRate" name="lr" value="0.01" step="0.001" min="0.001" max="1">
                                        </div>
                                        <small class="text-muted">Velocidade com que a IA aprende (0.01 √© ideal)</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Advanced Options -->
                        <div class="border-start border-info border-4 ps-3 mb-4">
                            <h6 class="text-info mb-3">
                                <i class="bi bi-4-circle-fill"></i>
                                Configura√ß√µes Avan√ßadas
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" role="switch" id="saveCheckpoints" name="save_checkpoints" checked>
                                        <label class="form-check-label" for="saveCheckpoints">
                                            <strong>üíæ Salvar Checkpoints</strong>
                                            <br><small class="text-muted">Salva o progresso durante o treino</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" role="switch" id="useAugmentation" name="use_augmentation" checked>
                                        <label class="form-check-label" for="useAugmentation">
                                            <strong>üé® Augmenta√ß√£o de Dados</strong>
                                            <br><small class="text-muted">Cria varia√ß√µes das imagens</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">
                                    <i class="bi bi-rocket"></i>
                                    Pronto para Treinar!
                                </h5>
                                <p class="card-text mb-4">
                                    Todas as configura√ß√µes est√£o definidas. O treinamento pode levar de alguns minutos a v√°rias horas.
                                </p>
                                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                                    <button type="submit" class="btn btn-light btn-lg px-5" id="startTrainingBtn">
                                        <i class="bi bi-play-circle-fill"></i>
                                        Iniciar Treinamento Agora
                                    </button>
                                    <button type="button" class="btn btn-outline-light" onclick="resetForm()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                        Limpar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Training Status -->
            <div class="card border-primary mb-3">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-activity"></i>
                        Status dos Treinamentos
                    </h6>
                </div>
                <div class="card-body">
                    <div id="trainingStatus">
                        <div class="text-muted text-center py-3">
                            <i class="bi bi-cpu display-4 text-muted"></i>
                            <div class="mt-2">Nenhum treinamento ativo</div>
                            <small>Os treinamentos em andamento aparecer√£o aqui</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Monitor -->
            <div class="card border-success mb-3">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-cpu"></i>
                        Monitor do Sistema
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="text-center p-3 bg-light rounded">
                                <div class="fw-bold text-primary h4" id="cpuUsage">-</div>
                                <div class="small text-muted">CPU</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 bg-light rounded">
                                <div class="fw-bold text-info h4" id="memoryUsage">-</div>
                                <div class="small text-muted">RAM</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 bg-light rounded">
                                <div class="fw-bold text-warning h4" id="diskUsage">-</div>
                                <div class="small text-muted">Disco</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 bg-light rounded">
                                <div class="fw-bold text-success h4" id="gpuStatus">-</div>
                                <div class="small text-muted">GPU</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Guide -->
            <div class="card border-info mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-question-circle"></i>
                        Guia R√°pido
                    </h6>
                </div>
                <div class="card-body">
                    <div class="accordion accordion-flush" id="tipsAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tip1">
                                    <i class="bi bi-lightbulb me-2"></i>
                                    Primeira vez?
                                </button>
                            </h2>
                            <div id="tip1" class="accordion-collapse collapse" data-bs-parent="#tipsAccordion">
                                <div class="accordion-body">
                                    Use as configura√ß√µes padr√£o! Elas funcionam bem para a maioria dos casos.
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tip2">
                                    <i class="bi bi-clock me-2"></i>
                                    Tempo esperado
                                </button>
                            </h2>
                            <div id="tip2" class="accordion-collapse collapse" data-bs-parent="#tipsAccordion">
                                <div class="accordion-body">
                                    ‚Ä¢ Dataset pequeno (100 imgs): 10-30 min<br>
                                    ‚Ä¢ Dataset m√©dio (500 imgs): 1-3 horas<br>
                                    ‚Ä¢ Dataset grande (1000+ imgs): 3+ horas
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tip3">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    Dica importante
                                </button>
                            </h2>
                            <div id="tip3" class="accordion-collapse collapse" data-bs-parent="#tipsAccordion">
                                <div class="accordion-body">
                                    N√£o feche o navegador durante o treinamento! Voc√™ pode acompanhar o progresso em tempo real.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="bi bi-graph-up"></i>
                        Estat√≠sticas
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h4 text-primary" id="totalTrainings">-</div>
                            <small class="text-muted">Total</small>
                        </div>
                        <div class="col-4">
                            <div class="h4 text-success" id="completedTrainings">-</div>
                            <small class="text-muted">Completos</small>
                        </div>
                        <div class="col-4">
                            <div class="h4 text-info" id="runningTrainings">-</div>
                            <small class="text-muted">Ativos</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let socket = null;

document.addEventListener('DOMContentLoaded', function() {
    loadDatasets();
    loadTrainingStats(); // Reativado com rota correta
    // setupWebSocket(); // Comentado temporariamente at√© WebSocket estar dispon√≠vel
    // updateSystemInfo(); // Comentado temporariamente at√© API estar dispon√≠vel
    
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    document.getElementById('trainingForm').addEventListener('submit', handleTrainingSubmit);
});

function loadDatasets() {
    fetch('/api/datasets')
        .then(response => {
            console.log('Dataset response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Dataset data received:', data);
            const select = document.getElementById('datasetSelect');
            select.innerHTML = '<option value="">üîç Selecione um dataset...</option>';
            
            if (data && data.datasets && data.datasets.length > 0) {
                data.datasets.forEach(dataset => {
                    const option = document.createElement('option');
                    option.value = dataset.id;
                    option.textContent = `üìä ${dataset.name}`;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML += '<option value="" disabled>üìù Nenhum dataset encontrado - Crie um primeiro</option>';
            }
        })
        .catch(error => {
            console.error('Error loading datasets:', error);
            const select = document.getElementById('datasetSelect');
            select.innerHTML = '<option value="">‚ö†Ô∏è Erro ao carregar datasets - Verifique o console</option>';
        });
}

function loadTrainingStats() {
    fetch('/api/trainings/stats')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('totalTrainings').textContent = data.total || 0;
            document.getElementById('completedTrainings').textContent = data.completed || 0;
            document.getElementById('runningTrainings').textContent = data.running || 0;
        })
        .catch(error => {
            console.warn('Training stats API not available:', error);
            document.getElementById('totalTrainings').textContent = '0';
            document.getElementById('completedTrainings').textContent = '0';
            document.getElementById('runningTrainings').textContent = '0';
        });
}

function updateSystemInfo() {
    fetch('/api/system/info')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('cpuUsage').textContent = data.cpu_percent ? `${data.cpu_percent}%` : '-';
            document.getElementById('memoryUsage').textContent = data.memory_percent ? `${data.memory_percent}%` : '-';
            document.getElementById('diskUsage').textContent = data.disk_percent ? `${data.disk_percent}%` : '-';
            document.getElementById('gpuStatus').textContent = data.gpu_available ? 'GPU' : 'CPU';
        })
        .catch(error => {
            console.warn('System info API not available:', error);
            document.getElementById('cpuUsage').textContent = '-';
            document.getElementById('memoryUsage').textContent = '-';
            document.getElementById('diskUsage').textContent = '-';
            document.getElementById('gpuStatus').textContent = '-';
        });
}

function setupWebSocket() {
    // WebSocket setup for real-time updates - opcional
    try {
        if (socket) {
            socket.close();
        }
        
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        socket = new WebSocket(`${protocol}//${window.location.host}/ws`);
        
        socket.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'training_update') {
                    updateTrainingStatus(data.data);
                }
            } catch (error) {
                console.warn('Error parsing WebSocket message:', error);
            }
        };
        
        socket.onerror = function(error) {
            console.warn('WebSocket connection failed:', error);
        };
        
        socket.onclose = function() {
            console.info('WebSocket connection closed');
        };
    } catch (error) {
        console.warn('WebSocket not available:', error);
    }
}

function updateTrainingStatus(data) {
    const statusDiv = document.getElementById('trainingStatus');
    if (data.status === 'running') {
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <h6><i class="bi bi-gear-fill"></i> Treinamento em Andamento</h6>
                <p>√âpoca: ${data.epoch}/${data.total_epochs}</p>
                <div class="progress">
                    <div class="progress-bar" style="width: ${(data.epoch/data.total_epochs*100)}%"></div>
                </div>
            </div>
        `;
    }
}

function handleTrainingSubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    if (!data.dataset_id) {
        alert('Por favor, selecione um dataset!');
        return;
    }
    
    const button = document.getElementById('startTrainingBtn');
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Iniciando...';
    
    fetch('/api/trainings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success || data.training_id) {
            alert('Treinamento criado com sucesso!');
            const trainingId = data.training_id || data.id;
            if (trainingId) {
                window.location.href = `/training/${trainingId}`;
            } else {
                window.location.href = '/trainings';
            }
        } else {
            alert('Erro ao criar treinamento: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao iniciar treinamento: ' + error.message);
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-play-circle-fill"></i> Iniciar Treinamento Agora';
    });
}

function resetForm() {
    document.getElementById('trainingForm').reset();
    document.getElementById('datasetSelect').value = '';
}

// Update system info every 30 seconds - comentado at√© APIs estarem dispon√≠veis
// setInterval(updateSystemInfo, 30000);
// setInterval(loadTrainingStats, 30000);
</script>
{% endblock %}